<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Punjai Thalavaipalyam Panjayath - Water Meter Readings 2025</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: linear-gradient(to bottom right, #e0f7fa, #ffffff);
    color: #0d47a1;
  }
  .water-header {
    position: relative;
    overflow: hidden;
    padding: 20px 10px 60px 10px;
    background: linear-gradient(135deg, #0288d1, #26c6da);
    color: white;
    font-weight: 700;
    font-size: 1.5rem;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .wave {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 200%;
    height: 50px;
    background-size: 600px 50px;
    animation: waveAnim 6s linear infinite;
    opacity: 0.6;
  }
  .wave2 { animation: waveAnim 8s linear infinite reverse; opacity: 0.5; }
  .wave3 { animation: waveAnim 10s linear infinite; opacity: 0.4; }
  @keyframes waveAnim { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

  .main-content {
    max-width: 1200px;
    margin: auto;
    padding: 20px;
  }
  select {
    padding: 10px;
    font-size: 1rem;
    border: 1px solid #b3e5fc;
    border-radius: 8px;
    background: white;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    margin-bottom: 15px;
  }
  #lastUpdated {
    text-align: center;
    color: #01579b;
    font-size: 0.9rem;
    margin-bottom: 15px;
  }
  .container {
    overflow-x: auto;
    background: rgba(255,255,255,0.95);
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,150,255,0.15);
    border: 1px solid #b3e5fc;
  }
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 13px;
  }
  th, td {
    padding: 10px;
    text-align: center;
    border: 1px solid #e0f2f1;
    vertical-align: middle;
  }
  th {
    background: linear-gradient(135deg, #0288d1, #26c6da);
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  .row-even { background-color: rgba(224,247,250,0.5); }
  .total-row { background: linear-gradient(135deg, #b2ff59, #76ff03); color: #1b5e20; font-weight: bold; }
  .average-row { background: linear-gradient(135deg, #fff176, #ffd54f); color: #e65100; font-weight: bold; }
  .mld-group { background-color: #b3e5fc; color: #01579b; }
  .litres-group { background-color: #ede7f6; color: #4a148c; }
  @media (max-width: 600px) {
    th, td { font-size: 11px; padding: 6px; }
  }
</style>
</head>
<body>

<h2 class="water-header">
  Punjai Thalavaipalyam Panjayath - Water Meter Readings 2025
  <div class="wave" style="background: url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'50\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 30 Q 150 10 300 30 T 600 30 T 900 30 T 1200 30 V50 H0 Z\' fill=\'%23b3e5fc\'/%3E%3C/svg%3E');"></div>
  <div class="wave wave2" style="background: url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'50\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 30 Q 150 10 300 30 T 600 30 T 900 30 T 1200 30 V50 H0 Z\' fill=\'%230288d1\'/%3E%3C/svg%3E');"></div>
  <div class="wave wave3" style="background: url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'50\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 30 Q 150 10 300 30 T 600 30 T 900 30 T 1200 30 V50 H0 Z\' fill=\'%2301569b\'/%3E%3C/svg%3E');"></div>
</h2>

<div class="main-content">
  <div style="text-align:center;">
    <label for="monthSelect">Select Month: </label>
    <select id="monthSelect">
      <option value="Average">2025 Average</option>
      <option value="Jul">July</option>
      <option value="Aug">August</option>
      <option value="Sep">September</option>
      <option value="Oct">October</option>
      <option value="Nov">November</option>
      <option value="Dec">December</option>
    </select>
  </div>

  <div id="lastUpdated">Last updated: Loading...</div>

  <div class="container">
    <table id="dataTable"></table>
  </div>
</div>

<script>
const APPS_SCRIPT_WEB_APP_URL = "YOUR_DEPLOYED_SCRIPT_URL"; // change to your actual script URL

const GID_MAP = {
  "Average": "676595147",
  "Jul": "2038204618",
  "Aug": "812809410",
  "Sep": "555648873",
  "Oct": "521072477",
  "Nov": "1962131756",
  "Dec": "397538262"
};

const monthSelect = document.getElementById("monthSelect");
const table = document.getElementById("dataTable");
const lastUpdatedDiv = document.getElementById("lastUpdated");

function updateLastUpdatedText(timestamp, isCached = false) {
  if (typeof timestamp !== 'number' || isNaN(timestamp) || timestamp <= 0) {
    lastUpdatedDiv.textContent = "Last updated: Unknown";
    return;
  }
  const date = new Date(timestamp);
  const formatted = date.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
  lastUpdatedDiv.textContent = `Last updated: ${formatted}${isCached ? " (Cached)" : ""}`;
}

async function fetchLastModifiedTimestamp() {
  try {
    const url = `${APPS_SCRIPT_WEB_APP_URL}?info=lastModified`;
    const res = await fetch(url);
    if (!res.ok) return null;
    const json = await res.json();
    return json.lastModified;
  } catch {
    return null;
  }
}

async function fetchAndDisplayData(month) {
  const cacheKey = `data-${month}`;
  const cached = JSON.parse(localStorage.getItem(cacheKey));
  table.innerHTML = "<tr><td colspan='100%' style='text-align:center;'>Loading...</td></tr>";
  const sheetLastModified = await fetchLastModifiedTimestamp();

  if (sheetLastModified && cached && cached.sheetLastModified === sheetLastModified) {
    displayTable(cached.data);
    updateLastUpdatedText(sheetLastModified, true);
    return;
  }

  const gid = GID_MAP[month];
  const url = `${APPS_SCRIPT_WEB_APP_URL}?gid=${gid}`;
  const res = await fetch(url);
  if (!res.ok) {
    table.innerHTML = "<tr><td>Error loading data</td></tr>";
    return;
  }
  const data = await res.json();
  localStorage.setItem(cacheKey, JSON.stringify({ data, sheetLastModified }));
  displayTable(data);
  updateLastUpdatedText(sheetLastModified, false);
}

function displayTable(data) {
  const headers = data[0];
  const rows = data.slice(1);
  table.innerHTML = "";

  const categoryRow = document.createElement("tr");
  const subHeaderRow = document.createElement("tr");

  let i = 0;
  while (i < headers.length) {
    let headerText = headers[i].trim();

    if (headerText === "Water Meter Reading (MLD)") {
      const thCat = document.createElement("th");
      thCat.colSpan = 2;
      thCat.textContent = "Water Meter Reading (MLD)";
      thCat.classList.add("mld-group");
      thCat.style.textAlign = "center";
      categoryRow.appendChild(thCat);

      const thSub1 = document.createElement("th");
      thSub1.textContent = headers[i + 1];
      thSub1.classList.add("mld-group");
      thSub1.style.textAlign = "center";

      const thSub2 = document.createElement("th");
      thSub2.textContent = headers[i + 2];
      thSub2.classList.add("mld-group");
      thSub2.style.textAlign = "center";

      subHeaderRow.appendChild(thSub1);
      subHeaderRow.appendChild(thSub2);

      i += 3;
      continue;
    }

    if (headerText === "Water Meter Reading (Litters)") {
      const thCat = document.createElement("th");
      thCat.colSpan = 2;
      thCat.textContent = "Water Meter Reading (Litters)";
      thCat.classList.add("litres-group");
      thCat.style.textAlign = "center";
      categoryRow.appendChild(thCat);

      const thSub1 = document.createElement("th");
      thSub1.textContent = headers[i + 1];
      thSub1.classList.add("litres-group");
      thSub1.style.textAlign = "center";

      const thSub2 = document.createElement("th");
      thSub2.textContent = headers[i + 2];
      thSub2.classList.add("litres-group");
      thSub2.style.textAlign = "center";

      subHeaderRow.appendChild(thSub1);
      subHeaderRow.appendChild(thSub2);

      i += 3;
      continue;
    }

    const thCat = document.createElement("th");
    thCat.rowSpan = 2;
    thCat.textContent = headerText;
    thCat.style.textAlign = "center";
    categoryRow.appendChild(thCat);

    i++;
  }

  table.appendChild(categoryRow);
  table.appendChild(subHeaderRow);

  rows.forEach((row, idx) => {
    const tr = document.createElement("tr");
    if (row[0] && /total/i.test(row[0])) tr.className = "total-row";
    else if (row[0] && /average/i.test(row[0])) tr.className = "average-row";
    else if (idx % 2 === 0) tr.className = "row-even";

    row.forEach((cell) => {
      const td = document.createElement("td");
      td.textContent = cell || "";
      td.style.textAlign = "center";
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

monthSelect.addEventListener("change", () => {
  fetchAndDisplayData(monthSelect.value);
});

document.addEventListener("DOMContentLoaded", () => {
  fetchAndDisplayData(monthSelect.value);
});
</script>
</body>
</html>
