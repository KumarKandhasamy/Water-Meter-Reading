<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Punjai Thalavaipalyam Panjayath - CWSS Water Meter Readings 2025</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: linear-gradient(to bottom right, #e0f7fa, #ffffff);
    color: #0d47a1;
  }
  .water-header {
    position: relative;
    overflow: hidden;
    padding: 20px 10px 60px 10px;
    background: linear-gradient(135deg, #0288d1, #26c6da);
    color: white;
    font-weight: 700;
    font-size: 1.5rem;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .wave {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 200%;
    height: 50px;
    background-size: 600px 50px;
    animation: waveAnim 6s linear infinite;
    opacity: 0.6;
  }
  .wave2 { animation: waveAnim 8s linear infinite reverse; opacity: 0.5; }
  .wave3 { animation: waveAnim 10s linear infinite; opacity: 0.4; }
  @keyframes waveAnim {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
  .main-content {
    max-width: 1200px;
    margin: auto;
    padding: 20px;
  }
  select {
    padding: 10px;
    font-size: 1rem;
    border: 1px solid #b3e5fc;
    border-radius: 8px;
    background: white;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    margin-bottom: 15px;
  }
  #lastUpdated {
    text-align: center;
    color: #01579b;
    font-size: 0.9rem;
    margin-bottom: 15px;
  }
  .container {
    overflow-x: auto;
    background: rgba(255,255,255,0.95);
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,150,255,0.15);
    border: 1px solid #b3e5fc;
  }
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 13px;
  }
  th, td {
    padding: 8px;
    text-align: center;
    border: 1px solid #e0f2f1;
  }
  th {
    background: linear-gradient(135deg, #0288d1, #26c6da);
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  .row-even { background-color: rgba(224,247,250,0.5); }
  .total-row { background: linear-gradient(135deg, #b2ff59, #76ff03); color: #1b5e20; font-weight: bold; }
  .average-row { background: linear-gradient(135deg, #fff176, #ffd54f); color: #e65100; font-weight: bold; }

  /* Shimmer effect for loading */
  .shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.2s infinite;
    height: 14px;
    border-radius: 4px;
  }
  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }
</style>
</head>
<body>

<h2 class="water-header">
  Punjai Thalavaipalyam Panjayath - CWSS Water Meter Readings 2025
  <div class="wave" style="background:url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'50\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 30 Q 150 10 300 30 T 600 30 T 900 30 T 1200 30 V50 H0 Z\' fill=\'%23b3e5fc\'/%3E%3C/svg%3E');"></div>
  <div class="wave wave2" style="background:url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'50\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 30 Q 150 10 300 30 T 600 30 T 900 30 T 1200 30 V50 H0 Z\' fill=\'%230288d1\'/%3E%3C/svg%3E');"></div>
  <div class="wave wave3" style="background:url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'50\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 30 Q 150 10 300 30 T 600 30 T 900 30 T 1200 30 V50 H0 Z\' fill=\'%2301569b\'/%3E%3C/svg%3E');"></div>
</h2>

<div class="main-content">
  <div style="text-align:center;">
    <label for="monthSelect">Select Month: </label>
    <select id="monthSelect">
      <option value="Average">2025 Average</option>
      <option value="Jul">July</option>
      <option value="Aug">August</option>
      <option value="Sep">September</option>
      <option value="Oct">October</option>
      <option value="Nov">November</option>
      <option value="Dec">December</option>
    </select>
  </div>

  <div id="lastUpdated">Last updated: Loading...</div>

  <div class="container">
    <table id="dataTable"></table>
  </div>
</div>

  <script>
    // This is the URL for the Google Apps Script Web App you provided
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxttncBaDzW83nysVTpt1YHWGUoHefuUELfuoNZ-W-4vQWqhcHQN7LaoAMBBfqwV9s/exec";

const GID_MAP = {
  "Average": "676595147",
  "Jul": "2038204618",
  "Aug": "812809410",
  "Sep": "555648873",
  "Oct": "521072477",
  "Nov": "1962131756",
  "Dec": "397538262"
};

async function fetchLastModifiedTimestamp() {
  try {
    const res = await fetch(`${APPS_SCRIPT_WEB_APP_URL}?info=lastModified`);
    if (!res.ok) return null;
    const json = await res.json();
    return json.lastModified;
  } catch {
    return null;
  }
}

function updateLastUpdatedText(timestamp) {
  if (!timestamp) {
    document.getElementById("lastUpdated").textContent = "Last updated: Unknown";
    return;
  }
  const date = new Date(timestamp);
  document.getElementById("lastUpdated").textContent =
    "Last updated: " + date.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
}

function mergeCells(rowArray, startCol) {
  let merged = [];
  let i = startCol;
  while (i < rowArray.length) {
    let value = rowArray[i];
    let colspan = 1;
    for (let j = i + 1; j < rowArray.length; j++) {
      if (rowArray[j] === value) colspan++;
      else break;
    }
    merged.push({ text: value, colspan });
    i += colspan;
  }
  return merged;
}

function showShimmer() {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";
  for (let i = 0; i < 5; i++) {
    const tr = document.createElement("tr");
    for (let j = 0; j < 8; j++) {
      const td = document.createElement("td");
      td.innerHTML = '<div class="shimmer"></div>';
      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
}

function renderTable(data) {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";

  const header1 = data[0];
  const header2 = data[1];
  const header3 = data[2];

  const thead = document.createElement("thead");

  // Row 1
  const row1 = document.createElement("tr");
  const monthCell = document.createElement("th");
  monthCell.textContent = header1[0];
  monthCell.rowSpan = 3;
  monthCell.colSpan = 2;
  monthCell.style.verticalAlign = "middle";
  row1.appendChild(monthCell);
  mergeCells(header1, 2).forEach(cell => {
    const th = document.createElement("th");
    th.textContent = cell.text;
    th.colSpan = cell.colspan;
    th.style.verticalAlign = "middle";
    row1.appendChild(th);
  });
  thead.appendChild(row1);

  // Row 2
  const row2 = document.createElement("tr");
  mergeCells(header2, 2).forEach(cell => {
    const th = document.createElement("th");
    th.textContent = cell.text;
    th.colSpan = cell.colspan;
    th.style.verticalAlign = "middle";
    row2.appendChild(th);
  });
  thead.appendChild(row2);

  // Row 3
  const row3 = document.createElement("tr");
  for (let i = 2; i < header3.length; i++) {
    const th = document.createElement("th");
    th.textContent = header3[i];
    row3.appendChild(th);
  }
  thead.appendChild(row3);

  table.appendChild(thead);

  // Body
  const tbody = document.createElement("tbody");
  for (let r = 3; r < data.length; r++) {
    const tr = document.createElement("tr");
    if (r % 2 === 0) tr.className = "row-even";
    for (let c = 0; c < data[r].length; c++) {
      const td = document.createElement("td");
      td.textContent = data[r][c];
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
}

async function fetchAndDisplayData(month) {
  showShimmer();
  const timestamp = await fetchLastModifiedTimestamp();
  updateLastUpdatedText(timestamp);
  const gid = GID_MAP[month];
  const res = await fetch(`${APPS_SCRIPT_WEB_APP_URL}?gid=${gid}`);
  if (!res.ok) {
    document.getElementById("dataTable").innerHTML = "<tr><td>Error loading data</td></tr>";
    return;
  }
  const data = await res.json();
  renderTable(data);
}

document.getElementById("monthSelect").addEventListener("change", () => {
  fetchAndDisplayData(document.getElementById("monthSelect").value);
});

document.addEventListener("DOMContentLoaded", () => {
  fetchAndDisplayData(document.getElementById("monthSelect").value);
});
</script>
</body>
</html>
