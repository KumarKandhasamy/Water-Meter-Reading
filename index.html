<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Punjai Thalavaipalyam Panjayath - CWSS Water Meter Readings 2025</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: linear-gradient(to bottom right, #e0f7fa, #ffffff);
    color: #0d47a1;
    overflow-x: hidden;
  }
  .water-header {
    position: relative;
    overflow: hidden;
    padding: 20px 10px 60px 10px;
    background: linear-gradient(135deg, #0288d1, #26c6da);
    color: white;
    font-weight: 700;
    font-size: 1.5rem;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .wave {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 200%;
    height: 50px;
    background-size: 600px 50px;
    animation: waveAnim 6s linear infinite;
    opacity: 0.6;
  }
  .wave2 { animation: waveAnim 8s linear infinite reverse; opacity: 0.5; }
  .wave3 { animation: waveAnim 10s linear infinite; opacity: 0.4; }
  @keyframes waveAnim {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
  .main-content { max-width: 1200px; margin: auto; padding: 20px; }
  select {
    padding: 10px; font-size: 1rem; border: 1px solid #b3e5fc;
    border-radius: 8px; background: white;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1); margin-bottom: 15px;
  }
  #lastUpdated { text-align: center; color: #01579b; font-size: 0.9rem; margin-bottom: 15px; }
  .container {
    overflow-x: auto; background: rgba(255,255,255,0.95);
    border-radius: 12px; box-shadow: 0 8px 20px rgba(0,150,255,0.15);
    border: 1px solid #b3e5fc;
  }
  table {
    width: 100%; border-collapse: separate; border-spacing: 0;
    font-size: 13px; transition: transform 0.3s ease;
  }
  th, td {
    padding: 8px; text-align: center; border: 1px solid #e0f2f1;
  }
  th {
    background: linear-gradient(135deg, #0288d1, #26c6da);
    color: white; font-weight: 600; position: sticky; top: 0; z-index: 2;
  }
  .row-even { background-color: rgba(224,247,250,0.5); }
  .total-row { background: linear-gradient(135deg, #b2ff59, #76ff03); color: #1b5e20; font-weight: bold; }
  .average-row { background: linear-gradient(135deg, #fff176, #ffd54f); color: #e65100; font-weight: bold; }

  /* Mobile scaling adjustments */
  @media (max-width: 768px) {
    body { overflow: hidden; }
    table { font-size: 14px; }
    select { font-size: 1.1rem; }
    .water-header { font-size: 1.2rem; padding: 15px 5px 50px 5px; }
  }
</style>
</head>
<body>

<h2 class="water-header">
  Punjai Thalavaipalyam Panjayath - CWSS Water Meter Readings 2025
  <div class="wave" style="background: url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'50\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 30 Q 150 10 300 30 T 600 30 T 900 30 T 1200 30 V50 H0 Z\' fill=\'%23b3e5fc\'/%3E%3C/svg%3E');"></div>
  <div class="wave wave2" style="background: url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'50\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 30 Q 150 10 300 30 T 600 30 T 900 30 T 1200 30 V50 H0 Z\' fill=\'%230288d1\'/%3E%3C/svg%3E');"></div>
  <div class="wave wave3" style="background: url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'50\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 30 Q 150 10 300 30 T 600 30 T 900 30 T 1200 30 V50 H0 Z\' fill=\'%2301569b\'/%3E%3C/svg%3E');"></div>
</h2>

<div class="main-content">
  <div style="text-align:center;">
    <label for="monthSelect">Select Month: </label>
    <select id="monthSelect">
      <option value="Average">2025 Average</option>
      <option value="Jul">July</option>
      <option value="Aug">August</option>
      <option value="Sep">September</option>
      <option value="Oct">October</option>
      <option value="Nov">November</option>
      <option value="Dec">December</option>
    </select>
  </div>

  <div id="lastUpdated">Last updated: Loading...</div>

  <div class="container">
    <table id="dataTable"></table>
  </div>
</div>

  <script>
    // This is the URL for the Google Apps Script Web App you provided
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxttncBaDzW83nysVTpt1YHWGUoHefuUELfuoNZ-W-4vQWqhcHQN7LaoAMBBfqwV9s/exec";

const GID_MAP = {
  "Average": "676595147",
  "Jul": "2038204618",
  "Aug": "812809410",
  "Sep": "555648873",
  "Oct": "521072477",
  "Nov": "1962131756",
  "Dec": "397538262"
};

const monthSelect = document.getElementById("monthSelect");
const table = document.getElementById("dataTable");
const lastUpdatedDiv = document.getElementById("lastUpdated");

function updateLastUpdatedText(timestamp) {
  if (!timestamp) {
    lastUpdatedDiv.textContent = "Last updated: Unknown";
    return;
  }
  const date = new Date(timestamp);
  const formatted = date.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
  lastUpdatedDiv.textContent = `Last updated: ${formatted}`;
}

async function fetchLastModifiedTimestamp() {
  try {
    const res = await fetch(`${APPS_SCRIPT_WEB_APP_URL}?info=lastModified`);
    if (!res.ok) return null;
    const json = await res.json();
    return json.lastModified;
  } catch {
    return null;
  }
}

async function fetchAndDisplayData(month) {
  table.innerHTML = "<tr><td colspan='100%' style='text-align:center;'>Loading...</td></tr>";
  const sheetLastModified = await fetchLastModifiedTimestamp();
  updateLastUpdatedText(sheetLastModified);

  const gid = GID_MAP[month];
  const res = await fetch(`${APPS_SCRIPT_WEB_APP_URL}?gid=${gid}`);
  if (!res.ok) {
    table.innerHTML = "<tr><td>Error loading data</td></tr>";
    return;
  }
  const data = await res.json();
  displayTable(data);
  scaleTableForMobile();
}

function displayTable(data) {
  table.innerHTML = "";
  const headerRowsCount = 3;
  const thead = document.createElement("thead");
  let skipMap = Array(headerRowsCount).fill(0).map(() => []);

  for (let r = 0; r < headerRowsCount; r++) {
    const tr = document.createElement("tr");
    for (let c = 0; c < data[r].length; c++) {
      if (skipMap[r][c]) continue;
      const cellValue = data[r][c] || "";
      if (!cellValue) continue;

      let rowspan = 1, colspan = 1;
      for (let rr = r + 1; rr < headerRowsCount; rr++) {
        if (data[rr][c] === "" || data[rr][c] === cellValue) {
          rowspan++;
          skipMap[rr][c] = true;
        } else break;
      }
      for (let cc = c + 1; cc < data[r].length; cc++) {
        if (data[r][cc] === "" || data[r][cc] === cellValue) {
          colspan++;
          skipMap[r][cc] = true;
        } else break;
      }

      const th = document.createElement("th");
      th.textContent = cellValue;
      if (rowspan > 1) th.rowSpan = rowspan;
      if (colspan > 1) th.colSpan = colspan;
      tr.appendChild(th);
    }
    thead.appendChild(tr);
  }
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  for (let r = headerRowsCount; r < data.length; r++) {
    const tr = document.createElement("tr");
    if (r % 2 === 0) tr.classList.add("row-even");
    data[r].forEach(cell => {
      const td = document.createElement("td");
      td.textContent = cell;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
}

function scaleTableForMobile() {
  if (window.innerWidth <= 768) {
    const container = document.querySelector(".container");
    const tableElement = document.querySelector("table");
    tableElement.style.transformOrigin = "top center";
    const scaleX = container.clientWidth / tableElement.scrollWidth;
    const scaleY = (window.innerHeight - container.getBoundingClientRect().top - 20) / tableElement.scrollHeight;
    const scale = Math.min(scaleX, scaleY, 1);
    tableElement.style.transform = `scale(${scale})`;
  } else {
    document.querySelector("table").style.transform = "scale(1)";
  }
}

monthSelect.addEventListener("change", () => {
  fetchAndDisplayData(monthSelect.value);
});

window.addEventListener("resize", scaleTableForMobile);

document.addEventListener("DOMContentLoaded", () => {
  fetchAndDisplayData(monthSelect.value);
});
</script>
</body>
</html>
