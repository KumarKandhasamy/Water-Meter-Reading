<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Punjai Thalavaipalyam Panjayath CWSS-138/238 - Water Meter Readings 2025</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f3f4f6;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 {
      color: #1e3a8a;
      text-align: center;
      margin-bottom: 20px;
    }
    select {
      padding: 8px;
      margin: 10px;
      font-size: 16px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      width: calc(100% - 24px);
      max-width: 300px;
    }
    #lastUpdated {
      font-size: 12px;
      color: #6b7280;
      margin: 10px 0 20px 0;
      text-align: center;
    }
    .main-content {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-grow: 1;
      padding: 0 20px;
      box-sizing: border-box;
    }
    .select-wrapper {
      text-align: center;
      width: 100%;
    }
    .container {
      overflow-x: auto; /* Allow horizontal scrolling for the table */
      width: 100%;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-grow: 1; /* Allows the container to fill remaining vertical space */
      margin-bottom: 20px; /* Space at the bottom */
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 800px; /* Ensure table doesn't get too small */
      table-layout: auto; /* Changed to auto for better content fit, can be fixed if desired */
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      white-space: nowrap; /* Prevent text wrapping in cells by default */
    }
    th {
      background-color: #2563eb !important;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .row-even {
      background-color: #f9fafb !important;
    }
    .total-row {
      background-color: #a3e635 !important;
      font-weight: bold;
    }
    .average-row {
      background-color: #fde047 !important;
      font-weight: bold;
    }
    .mld-group {
      background-color: #93c5fd !important; /* Light blue for MLD */
    }
    .litres-group {
      background-color: #d8b4fe !important; /* Light purple for Litres */
    }
    /* Responsive adjustments for table cells if needed for wrapping */
    @media (max-width: 600px) {
      th, td {
        padding: 5px;
        font-size: 10px;
        white-space: normal; /* Allow text wrapping on smaller screens */
      }
    }
  </style>
</head>
<body>

  <h2>Punjai Thalavaipalyam Panjayath CWSS-138/238 - Water Meter Readings 2025</h2>

  <div class="main-content">
    <div class="select-wrapper">
      <label for="monthSelect">Select Month: </label>
      <select id="monthSelect">
        <option value="Average">2025 Average</option>
        <option value="Jul">July</option>
        <option value="Aug">August</option>
        <option value="Sep">September</option>
        <option value="Oct">October</option>
        <option value="Nov">November</option>
        <option value="Dec">December</option>
      </select>
    </div>

    <div id="lastUpdated">Last updated: Loading...</div>
    <div class="container">
      <table id="dataTable"></table>
    </div>
  </div>

  <script>
    // This is the URL for the Google Apps Script Web App you provided
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyRPZOPcqByBONAmMtMLoIiut1cd_bNwHHj7KOFDe7IYm7gryFXfJZPCWSkaoStqy9m/exec";

    const GID_MAP = {
      "Average": "676595147",
      "Jul": "2038204618",
      "Aug": "812809410",
      "Sep": "555648873",
      "Oct": "521072477",
      "Nov": "1962131756",
      "Dec": "397538262"
    };

    const monthSelect = document.getElementById("monthSelect");
    const table = document.getElementById("dataTable");
    const lastUpdatedDiv = document.getElementById("lastUpdated");

    // This function fetches and displays the data from the Google Apps Script
    async function fetchAndDisplayData(month) {
      const gid = GID_MAP[month];
      const url = `${APPS_SCRIPT_WEB_APP_URL}?gid=${gid}`;

      // Show a loading message
      table.innerHTML = "<tr><td colspan='100%' style='text-align:center;'>Loading data...</td></tr>";

      try {
        console.log("Attempting to fetch data from:", url);
        const response = await fetch(url);
        
        // A NetworkError often indicates a CORS issue or incorrect deployment settings.
        // It's not a status error (like 404), but a failure to connect.
        if (!response.ok) {
          const errorMsg = `Failed to fetch data with status code: ${response.status}. This may mean your Google Apps Script is not correctly deployed.`;
          throw new Error(errorMsg);
        }
        
        const data = await response.json(); // Data is already JSON thanks to Apps Script

        if (!data || data.length < 1) {
          table.innerHTML = "<tr><td colspan='100%' style='text-align:center;'>No data available for this month.</td></tr>";
          return;
        }

        // The first row of data is the header
        const headers = data[0];
        const rowsToDisplay = data.slice(1); // Remaining rows are data

        // Clear previous table
        table.innerHTML = "";

        // Add header row
        const headerRowElement = document.createElement("tr");
        headers.forEach((headerText, colIdx) => {
          const th = document.createElement("th");
          // Clean up "Column X" placeholders if they still appear from Apps Script `getDisplayValues`
          let displayHeader = headerText.trim() || '';
          if (displayHeader.match(/^Column \d+$/)) {
               displayHeader = '';
          }
          th.textContent = displayHeader;

          // Apply group classes based on header content
          if (displayHeader.includes("MLD")) th.classList.add("mld-group");
          else if (displayHeader.includes("Litters")) th.classList.add("litres-group");
          headerRowElement.appendChild(th);
        });
        table.appendChild(headerRowElement);

        // Add data rows
        rowsToDisplay.forEach((row, idx) => {
          const tr = document.createElement("tr");
          // Apply row-even for alternating colors
          tr.className = idx % 2 === 0 ? "row-even" : "";

          // Apply special row classes for Total and Average (case-insensitive check for first cell)
          if (row[0] && String(row[0]).toLowerCase().includes("total")) tr.className = "total-row";
          else if (row[0] && String(row[0]).toLowerCase().includes("average")) tr.className = "average-row";

          row.forEach((cellContent, colIdx) => {
            const td = document.createElement("td");
            td.textContent = cellContent || ""; // Handle empty cells
            // Apply color groups to cells based on the header of their column
            if (headers[colIdx] && headers[colIdx].includes("MLD")) td.classList.add("mld-group");
            else if (headers[colIdx] && headers[colIdx].includes("Litters")) td.classList.add("litres-group");
            tr.appendChild(td);
          });
          table.appendChild(tr);
        });

      } catch (error) {
        console.error("Error fetching or displaying data:", error);
        // Display a more helpful error message for the user
        const errorMessage = `
          <div style='text-align:left; padding: 20px; background-color: #fee2e2; border-radius: 8px; border: 1px solid #fca5a5; color: #b91c1c; font-size: 14px;'>
            <p><strong>Failed to load data. This is likely due to an issue with your Google Apps Script deployment.</strong></p>
            <p>Please follow these steps to fix the issue:</p>
            <ol>
              <li>Go to your Google Apps Script project for the spreadsheet.</li>
              <li>Click on "Deploy" > "Manage deployments" or "New deployment".</li>
              <li>Ensure the deployment is a "Web app".</li>
              <li>Under "Who has access", select "Anyone". This is a critical step.</li>
              <li>Click "Deploy" (or "Done" to save changes) and get the new URL if it changed.</li>
              <li>Make sure the URL in this script matches the Web App URL exactly: <code>${APPS_SCRIPT_WEB_APP_URL}</code></li>
            </ol>
            <p>Original error: ${error.message}</p>
          </div>
        `;
        table.innerHTML = `<tr><td colspan='100%'>${errorMessage}</td></tr>`;
      }
    }

    function updateLastUpdatedToCurrentTime() {
      const now = new Date();
      lastUpdatedDiv.textContent = `Last updated: ${now.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}`;
    }

    // Event listener for dropdown
    monthSelect.addEventListener("change", () => {
      const selectedMonth = monthSelect.value;
      fetchAndDisplayData(selectedMonth);
      updateLastUpdatedToCurrentTime();
    });

    // Initial load
    fetchAndDisplayData(monthSelect.value);
    updateLastUpdatedToCurrentTime();
  </script>

</body>
</html>
