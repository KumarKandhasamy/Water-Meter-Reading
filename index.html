<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Punjai Thalavaipalyam Panjayath CWSS-138/238 - Water Meter Readings 2025</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f3f4f6;
      padding: 20px;
      margin: 0;
    }
    h2 {
      color: #1e3a8a;
      text-align: center;
      margin-bottom: 20px;
    }
    select {
      padding: 8px;
      margin: 10px;
      font-size: 16px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      width: calc(100% - 24px);
      max-width: 300px;
    }
    table {
      width: 100%;
      min-width: 800px; /* Ensure minimum width to prevent collapse */
      border-collapse: collapse;
      font-size: 12px;
      background: white;
      margin-top: 10px;
      table-layout: fixed; /* Fixed layout to control column widths */
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
      word-wrap: break-word; /* Prevent text overflow */
    }
    th {
      background-color: #2563eb !important;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .row-even {
      background-color: #f9fafb !important;
    }
    .total-row {
      background-color: #a3e635 !important; /* Green for Total */
      font-weight: bold;
    }
    .average-row {
      background-color: #fde047 !important; /* Yellow for Average */
      font-weight: bold;
    }
    /* Specific column widths for better layout */
    #dataTable th:nth-child(1),
    #dataTable td:nth-child(1) { width: 5%; } /* S.No */
    #dataTable th:nth-child(2),
    #dataTable td:nth-child(2) { width: 10%; } /* Date */
    #dataTable th:nth-child(3),
    #dataTable td:nth-child(3) { width: 10%; } /* Main Ent (MLD) */
    #dataTable th:nth-child(4),
    #dataTable td:nth-child(4) { width: 10%; } /* MGP C&EK (MLD) */
    #dataTable th:nth-child(5),
    #dataTable td:nth-child(5) { width: 10%; } /* MGP (MLD) */
    #dataTable th:nth-child(6),
    #dataTable td:nth-child(6) { width: 10%; } /* Main Ent (CWSS-238 MLD) */
    #dataTable th:nth-child(7),
    #dataTable td:nth-child(7) { width: 10%; } /* Main Ent (Litters) */
    #dataTable th:nth-child(8),
    #dataTable td:nth-child(8) { width: 10%; } /* MGP C&EK (Litters) */
    #dataTable th:nth-child(9),
    #dataTable td:nth-child(9) { width: 10%; } /* MGP (Litters) */
    #dataTable th:nth-child(10),
    #dataTable td:nth-child(10) { width: 10%; } /* Sump (Litters) */
    #dataTable th:nth-child(11),
    #dataTable td:nth-child(11) { width: 10%; } /* Main Ent (CWSS-238 Litters) */

    /* New classes for MLD and Litters groups for better readability and maintainability */
    .mld-group {
      background-color: #93c5fd !important; /* Light blue for MLD */
    }
    .litres-group {
      background-color: #d8b4fe !important; /* Light purple for Litres */
    }

    #lastUpdated {
      font-size: 12px;
      color: #6b7280;
      margin: 10px 0;
      text-align: center;
    }
    .container {
      overflow-x: auto; /* Ensure horizontal scroll if needed */
      max-width: 1200px; /* Max width for content on larger screens */
      margin: 0 auto; /* Center the main content area */
      padding: 0 20px; /* Add some horizontal padding */
      box-sizing: border-box; /* Include padding in width calculation */
    }

    /* Media queries for fine-tuning on smaller screens */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      h2 {
        font-size: 1.5em;
      }
      select {
        font-size: 14px;
        padding: 6px;
      }
      .container {
        padding: 0 10px;
      }
      table {
        min-width: unset; /* Allow table to shrink on very small screens */
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <h2>Punjai Thalavaipalyam Panjayath CWSS-138/238 - Water Meter Readings 2025</h2>

  <div style="text-align: center;">
    <label for="monthSelect">Select Month: </label>
    <select id="monthSelect">
      <option value="Average">2025 Average</option>
      <option value="Jul">July</option>
      <option value="Aug">August</option>
      <option value="Sep">September</option>
      <option value="Oct">October</option>
      <option value="Nov">November</option>
      <option value="Dec">December</option>
    </select>
  </div>

  <div id="lastUpdated">Last updated: Loading...</div>
  <div class="container">
    <table id="dataTable"></table>
  </div>

  <script>
    // This map now holds the contentFetchId for each CSV file you uploaded
    const FILE_FETCH_IDS = {
      "Average": "uploaded:water_meter_readings.xlsx - 2025 Average.csv",
      "Jul": "uploaded:water_meter_readings.xlsx - Jul.csv",
      "Aug": "uploaded:water_meter_readings.xlsx - Aug.csv",
      "Sep": "uploaded:water_meter_readings.xlsx - Sep.csv",
      "Oct": "uploaded:water_meter_readings.xlsx - Oct.csv",
      "Nov": "uploaded:water_meter_readings.xlsx - Nov.csv",
      "Dec": "uploaded:water_meter_readings.xlsx - Dec.csv"
    };

    const monthSelect = document.getElementById("monthSelect");
    const table = document.getElementById("dataTable");
    const lastUpdatedDiv = document.getElementById("lastUpdated");

    // --- CSV Parsing Logic ---
    function parseCSV(csv) {
      const rows = csv.trim().split("\n").map(row => row.split(",").map(cell => cell.trim()));

      let headerRowIndex = -1;
      // Find the header row by looking for "S.No" and "Date"
      for (let i = 0; i < rows.length; i++) {
        if (rows[i].includes("S.No") && rows[i].includes("Date")) {
          headerRowIndex = i;
          break;
        }
      }

      if (headerRowIndex === -1) {
        console.warn("Header row (S.No, Date) not found. Attempting to use the first row with enough content as header.");
        // Fallback: Find the first row that is not completely empty and has at least 3 cells
        for (let i = 0; i < rows.length; i++) {
            if (rows[i].filter(cell => cell !== '').length >= 3) {
                headerRowIndex = i;
                break;
            }
        }
        if (headerRowIndex === -1) { // If still not found, default to 0
            headerRowIndex = 0;
            console.error("Could not determine header row. Using the very first row.");
        }
      }

      const rawDataStartingFromHeader = rows.slice(headerRowIndex);

      // Determine the column range based on the header row's content
      const header = rawDataStartingFromHeader[0];
      let firstFilledCol = -1;
      let lastFilledCol = -1;

      for (let i = 0; i < header.length; i++) {
        if (header[i] !== '') {
          if (firstFilledCol === -1) {
            firstFilledCol = i;
          }
          lastFilledCol = i;
        }
      }

      // If header is empty or sparse, we need a more robust way to define the actual data columns.
      if (firstFilledCol === -1 || lastFilledCol === -1 || (lastFilledCol - firstFilledCol + 1 < 5 && rawDataStartingFromHeader.length > 1)) {
          console.warn("Header range not clearly defined by filled headers. Re-evaluating column range based on data rows.");
          let tempFirst = Infinity;
          let tempLast = -1;

          for (let i = 1; i < Math.min(rawDataStartingFromHeader.length, 11); i++) {
              rawDataStartingFromHeader[i].forEach((cell, colIdx) => {
                  if (cell !== '') {
                      if (colIdx < tempFirst) tempFirst = colIdx;
                      if (colIdx > tempLast) tempLast = colIdx;
                  }
              });
          }
          if (tempFirst !== Infinity) firstFilledCol = Math.min(firstFilledCol === -1 ? Infinity : firstFilledCol, tempFirst);
          if (tempLast !== -1) lastFilledCol = Math.max(lastFilledCol, tempLast);

          if (firstFilledCol === Infinity || lastFilledCol === -1) {
              firstFilledCol = 0;
              lastFilledCol = header.length > 0 ? header.length - 1 : 10;
              console.warn("Failed to determine column range, defaulting to columns from 0 to", lastFilledCol);
          }
      }

      // Crop all rows (including the header) to the identified column range
      return rawDataStartingFromHeader.map(row => row.slice(firstFilledCol, lastFilledCol + 1));
    }

    // --- Data Fetching and Table Rendering ---
    async function fetchDataAndRenderTable(month) {
      const fetchId = FILE_FETCH_IDS[month];
      if (!fetchId) {
        table.innerHTML = "<tr><td colspan='100%'>File not found for this month.</td></tr>";
        return;
      }

      try {
        // Use file_content_fetcher to get the content of the CSV file
        const csvContent = await new Promise((resolve, reject) => {
          // This is a placeholder for the actual tool call.
          // In a real environment, this would be an API call like:
          // print(file_content_fetcher.fetch(query='Get sheet data for ' + month, source_references=[fetchId]))
          // For demonstration, we'll simulate it, but in the actual environment
          // this will be replaced by the tool's output.
          console.log(`Fetching content for: ${fetchId}`);
          // Replace this with the actual tool call's output mechanism
          // For testing, you might need to manually input CSV content here
          // resolve("S.No,Date,Main Ent,MGP C&EK,MGP,Main Ent (CWSS-238),Main Ent (Litters),MGP C&EK (Litters),MGP (Litters),Sump (Litters),Main Ent (CWSS-238 Litters)\n0,2025-06-30,10,20,30,40,10000,20000,30000,40000,50000\n1,2025-07-01,11,21,31,41,11000,21000,31000,41000,51000"); // Example dummy CSV
          // The environment will execute the tool_code and provide the output here.
          // Since I cannot directly execute tools in this JS block, I will prompt
          // for the actual tool call to be performed externally.
          // The response will include a `tool_code` block for the fetch.
          // Once the content is fetched, it will proceed.
        });

        const processedRows = parseCSV(csvContent);

        if (processedRows.length < 2) { // Need at least a header and one data row
          table.innerHTML = "<tr><td colspan='100%'>No data or insufficient data available for this month.</td></tr>";
          return;
        }

        // Clear previous table
        table.innerHTML = "";

        // The first row of processedRows is always the header
        const headers = processedRows[0];
        const dataToDisplay = processedRows.slice(1); // All subsequent rows are data

        // Create and append table header
        const headerRowElement = document.createElement("tr");
        headers.forEach((header, idx) => {
          const th = document.createElement("th");
          let displayHeader = header || '';
          // Condition to ignore "Column X" placeholders if they appear
          if (displayHeader.match(/^Column \d+$/)) { // Matches "Column 1", "Column 2", etc.
               displayHeader = '';
          }
          th.textContent = displayHeader;

          // Apply group classes based on header content
          if (displayHeader.includes("MLD")) th.classList.add("mld-group");
          else if (displayHeader.includes("Litters")) th.classList.add("litres-group");
          headerRowElement.appendChild(th);
        });
        table.appendChild(headerRowElement);

        // Add data rows with merging and color coding
        dataToDisplay.forEach((row, idx) => {
          const tr = document.createElement("tr");
          tr.className = idx % 2 === 0 ? "row-even" : "";

          // Apply special row classes for Total and Average (case-insensitive check for first cell)
          if (row[0] && row[0].toLowerCase() === "total") tr.className = "total-row";
          else if (row[0] && row[0].toLowerCase() === "average") tr.className = "average-row";

          row.forEach((cell, colIdx) => {
            const td = document.createElement("td");
            td.textContent = cell || ""; // Handle empty cells

            // Apply color groups to cells based on the header of their column
            if (headers[colIdx] && headers[colIdx].includes("MLD")) td.classList.add("mld-group");
            else if (headers[colIdx] && headers[colIdx].includes("Litters")) td.classList.add("litres-group");

            td.style.minWidth = '50px'; // Ensure a minimum width for cells to prevent squishing
            tr.appendChild(td);
          });
          table.appendChild(tr);
        });
      } catch (err) {
        console.error("Error fetching or rendering data:", err);
        table.innerHTML = "<tr><td colspan='100%'>Failed to load data. Please try again.</td></tr>";
      }
    }

    function updateLastUpdatedToCurrentTime() {
      const now = new Date();
      lastUpdatedDiv.textContent = `Last updated: ${now.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}`;
    }

    // Event listener for dropdown
    monthSelect.addEventListener("change", () => {
      const selectedMonth = monthSelect.value;
      fetchDataAndRenderTable(selectedMonth);
      updateLastUpdatedToCurrentTime();
    });

    // Initial load
    fetchDataAndRenderTable(monthSelect.value);
    updateLastUpdatedToCurrentTime();
  </script>

</body>
</html>
