<!DOCTYPE html>
<html>
<head>
  <title>Punjai Thalavaipalayam Panjayath CWSS138/238 Water Meter Readings</title>
  <meta charset="utf-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    select {
      margin-bottom: 20px;
    }
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 6px;
    }
    th {
      background-color: #f0f0f0;
    }
    #lastUpdated {
      margin-top: 10px;
      font-style: italic;
      color: gray;
    }
  </style>
</head>
<body>

  <h2>Monthly Data Viewer</h2>

  <label for="monthSelect">Select Month:</label>
  <select id="monthSelect"></select>

  <div id="lastUpdated"></div>
  <br>
  <table id="dataTable"></table>

  <script>
    const SHEET_ID = "2PACX-1vSZgyKDVKi31ku5JZ3sHK9HO0ncbIAJkTOzyFZgXw7KVZ9bi7oMqbgUkILKjF1zaVP4GcchfUHFTTVs";
    const SHEET_URL_PREFIX = "https://docs.google.com/spreadsheets/d/e/";
    const SHEET_META_API = `https://docs.google.com/spreadsheets/d/${SHEET_ID.split('-')[0]}/gviz/tq`;

    // List your sheet names (as per month)
    const sheetNames = ["Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    const monthSelect = document.getElementById('monthSelect');
    const table = document.getElementById('dataTable');
    const lastUpdated = document.getElementById('lastUpdated');

    sheetNames.forEach(sheet => {
      const opt = document.createElement("option");
      opt.value = sheet;
      opt.textContent = sheet;
      monthSelect.appendChild(opt);
    });

    monthSelect.addEventListener("change", () => {
      fetchCSV(monthSelect.value);
    });

    async function fetchCSV(sheetName) {
      const url = `${SHEET_URL_PREFIX}${SHEET_ID}/pub?output=csv&sheet=${sheetName}`;
      const response = await fetch(url);
      const csvText = await response.text();
      const rows = csvText.trim().split('\n').map(row => row.split(','));

      // Clear table
      table.innerHTML = "";

      // Populate table
      rows.forEach((row, rowIndex) => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement(rowIndex === 0 ? "th" : "td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });

      // Update last updated text
      updateLastModified(sheetName);
    }

    async function updateLastModified(sheetName) {
      try {
        const res = await fetch(SHEET_META_API);
        const text = await res.text();
        const match = text.match(/"lastModifiedTime":"(.*?)"/);
        if (match) {
          const date = new Date(match[1]);
          lastUpdated.textContent = `Last updated: ${date.toLocaleString()}`;
        } else {
          lastUpdated.textContent = "";
        }
      } catch (e) {
        lastUpdated.textContent = "";
      }
    }

    // Initial load
    monthSelect.value = sheetNames[0];
    fetchCSV(sheetNames[0]);
  </script>

</body>
</html>
