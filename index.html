<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Water Meter Readings 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50 font-sans">
  <div id="root"></div>

  <script type="text/babel">
    // This top script block is unused by the React app and can be removed, but is left for context.
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    // ... other functions from the original script

    // Defining the main App component
    function App() {
      const [month, setMonth] = React.useState('Jul');
      const [data, setData] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      
      // Defining available months corresponding to Excel sheets
      const months = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      // Function to convert Excel serial date to DD-MMM-YYYY format
      const excelSerialToDate = (serial) => {
        if (!serial || isNaN(serial)) return '';
        const utc_days = Math.floor(serial - 25569);
        const date = new Date(utc_days * 86400 * 1000);
        const day = date.getUTCDate();
        const month = date.toLocaleString('en-US', { month: 'short' });
        const year = date.getUTCFullYear();
        return `${day}-${month}-${year}`;
      };

      // Loading and parsing Excel data when month changes
      React.useEffect(() => {
        setLoading(true);
        setError(null);

        // Fetch the Excel file directly from your repository.
        // Ensure the filename matches exactly what you uploaded to GitHub.
        fetch('water_meter_readings.xlsx')
          .then(response => {
            if (!response.ok) {
              throw new Error('Could not load the data file. Please check the filename.');
            }
            return response.arrayBuffer();
          })
          .then(fileData => {
            const workbook = XLSX.read(fileData, { type: 'array' });
            const sheetName = month; // Use selected month as sheet name
            const worksheet = workbook.Sheets[sheetName];
            
            if (!worksheet) {
              setData([]); // Clear any old data
              throw new Error(`Data for "${sheetName}" not found in the Excel file.`);
            }

            // Convert sheet to JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
              header: ['S.No', 'Date', 'Main Ent (MLD) 138', 'MGP C&EK (MLD) 138', 'MGP (MLD) 138', 'Main Ent (MLD) 238', 'Main Ent (Litters) 138', 'MGP C&EK (Litters) 138', 'MGP (Litters) 138', 'Sump (Litters) 238', 'Main Ent (Litters) 238'],
              defval: '',
              raw: false,
              dateNF: 'dd-mmm-yyyy'
            });

            // Transform Date column from Excel serial to DD-MMM-YYYY
            const transformedData = jsonData.map(row => ({
              ...row,
              Date: row.Date && !isNaN(row.Date) ? excelSerialToDate(parseInt(row.Date, 10)) : row.Date
            }));

            // Your logic requires skipping the first 3 rows of data.
            // We do this here to keep the rendering logic clean.
            const finalData = transformedData.slice(3);

            setData(finalData);
            setLoading(false);
          })
          .catch(err => {
            console.error(err);
            setError(err.message); // Display a helpful error message
            setLoading(false);
          });
      }, [month]); // This effect re-runs whenever the 'month' state changes

      // Handling month selection change
      const handleMonthChange = (event) => {
        setMonth(event.target.value);
      };

      // Defining columns for MLD and Litres sections
      const mldColumns = ['Main Ent (MLD) 138', 'MGP C&EK (MLD) 138', 'MGP (MLD) 138', 'Main Ent (MLD) 238'];
      const litresColumns = ['Main Ent (Litters) 138', 'MGP C&EK (Litters) 138', 'MGP (Litters) 138', 'Sump (Litters) 238', 'Main Ent (Litters) 238'];
      const commonColumns = ['S.No', 'Date'];

      // Rendering the component
      return (
        <div className="container mx-auto p-1">
          <h1 className="text-lg font-bold mb-2 text-center text-blue-800">
            Punjai Thalavaipalayam CWSS 138/238 Water Meter Readings 2025
          </h1>
          
          <div className="mb-2 flex justify-center items-center">
            <label htmlFor="month-select" className="mr-1 text-xs font-medium text-gray-700">Select Month:</label>
            <select
              id="month-select"
              value={month}
              onChange={handleMonthChange}
              className="border-2 border-blue-300 rounded-lg p-0.5 bg-white text-gray-800 text-xs focus:outline-none focus:border-blue-500"
            >
              {months.map(m => (
                <option key={m} value={m}>{m}</option>
              ))}
            </select>
          </div>

          {loading ? (
            <div className="text-center text-gray-600 text-xs">Loading...</div>
          ) : error ? (
            <div className="text-center text-red-600 text-xs p-4 bg-red-100 rounded-lg">{error}</div>
          ) : (
            <div className="shadow-lg rounded-lg overflow-x-auto">
              <table className="w-full bg-white border-4 border-gray-400 text-[10px]">
                <thead>
                  <tr className="text-white sticky top-0 bg-white">
                    {commonColumns.map((header) => (
                      <th key={header} className="px-1 py-0.5 border-b-4 border-r-4 border-gray-400 text-left font-semibold uppercase tracking-tighter bg-blue-600">
                        {header}
                      </th>
                    ))}
                    {mldColumns.map((header) => (
                      <th key={header} className="px-1 py-0.5 border-b-4 border-r-4 border-gray-400 text-left font-semibold uppercase tracking-tighter bg-blue-700">
                        {header}
                      </th>
                    ))}
                    {litresColumns.map((header) => (
                      <th key={header} className="px-1 py-0.5 border-b-4 border-r-4 border-gray-400 text-left font-semibold uppercase tracking-tighter bg-purple-700">
                        {header}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {data.map((row, rowIndex) => (
                    <tr 
                      key={rowIndex} 
                      className={
                        row['S.No'] === 'Total' ? 'bg-green-100 font-bold' :
                        row['S.No'] === 'Average' ? 'bg-yellow-100 font-bold' :
                        (rowIndex + 1) % 2 === 0 ? 'bg-gray-50' : 'bg-white'
                      }
                    >
                      {commonColumns.map((key) => (
                        <td key={key} className="px-1 py-0.5 border-b-4 border-r-4 border-gray-400 text-gray-800">
                          {row[key]}
                        </td>
                      ))}
                      {mldColumns.map((key) => (
                        <td key={key} className="px-1 py-0.5 border-b-4 border-r-4 border-gray-400 text-gray-800 bg-blue-50">
                          {row[key]}
                        </td>
                      ))}
                      {litresColumns.map((key) => (
                        <td key={key} className="px-1 py-0.5 border-b-4 border-r-4 border-gray-400 text-gray-800 bg-purple-50">
                          {row[key]}
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      );
    }

    // Rendering the App component
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
