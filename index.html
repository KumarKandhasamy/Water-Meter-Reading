<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Punjai Thalavaipalyam Panjayath - CWSS Water Meter Readings 2025</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --blue-1:#0b74c9;
    --blue-2:#26c6da;
    --muted:#f5fbff;
    --accent:#034f84;
    --mld-bg:#cfefff;
    --litres-bg:#fff3cc;
  }
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;
    background: linear-gradient(135deg,#e9f9ff 0%, #ffffff 100%);
    color:var(--accent);
  }
  .water-header{
    position:relative;
    padding:20px 16px 64px;
    color:white;
    text-align:center;
    background: linear-gradient(135deg,var(--blue-1), var(--blue-2));
    box-shadow:0 6px 18px rgba(11,116,201,0.12);
    font-weight:700;
    font-size:1.25rem;
  }
  .wave{ position:absolute; left:0; bottom:0; width:200%; height:56px; background-size:600px 56px; opacity:0.6; animation:wave 9s linear infinite; }
  .wave2{ animation-duration:12s; opacity:0.45; }
  .wave3{ animation-duration:15s; opacity:0.35; }
  @keyframes wave { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }

  .main { max-width:1200px; margin:18px auto; padding:0 16px; }
  .controls { text-align:center; margin-bottom:10px; }
  select { padding:9px 12px; border-radius:8px; border:1px solid rgba(3,169,244,0.12); background:white; box-shadow:0 2px 6px rgba(2,136,209,0.04); font-size:1rem; }

  #lastUpdated { text-align:center; color:#0a6aa0; margin:8px 0 14px; font-size:0.9rem; }

  .container {
    background: rgba(255,255,255,0.98);
    border-radius:12px;
    overflow:auto;
    border:1px solid rgba(3,169,244,0.08);
    box-shadow:0 10px 30px rgba(2,136,209,0.06);
    padding:8px;
  }

  table {
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width:980px;
    font-size:13px;
    opacity:0;
    transform: translateY(6px);
    transition: opacity 300ms ease, transform 300ms ease;
  }
  table.visible { opacity:1; transform: translateY(0); }

  thead th, tbody td {
    padding:10px 8px;
    border:1px solid #e6f2f6;
    vertical-align:middle;
    text-align:center;
  }

  thead th {
    background: linear-gradient(135deg,var(--blue-1), var(--blue-2));
    color:white; font-weight:600;
    position: sticky;
    top:0;
    z-index:6;
  }

  /* color cues for MLD / Litres group cells (applied dynamically) */
  .group-mld { background: linear-gradient(180deg,#d6f1ff,#bfeaff); color:var(--accent); }
  .group-litres { background: linear-gradient(180deg,#fff6d6,#ffe9b3); color: #5a3e00; }

  tbody tr.row-even td { background:#f6fcff; }
  tbody tr.total-row td { background: linear-gradient(135deg,#e9ffb3,#b7ff59); color:#164d1b; font-weight:700; }
  tbody tr.average-row td { background: linear-gradient(135deg,#fff1a8,#ffd54f); color:#7a3e00; font-weight:700; }

  /* shimmer loader for placeholders */
  .shimmer { height:14px; border-radius:6px; background:linear-gradient(90deg,#e6f2f7 25%, #d7eefa 50%, #e6f2f7 75%); background-size:200% 100%; animation:shimmer 1.1s linear infinite; }
  @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }

  @media (max-width:700px){
    thead th, tbody td{ padding:8px 6px; font-size:12px; }
    .water-header{ font-size:1.05rem; padding-bottom:46px; }
  }
</style>
</head>
<body>

  <header class="water-header">
  Punjai Thalavaipalyam Panjayath - CWSS Water Meter Readings 2025
    <div class="wave" style="background:url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'56\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 34 Q 150 10 300 34 T 600 34 T 900 34 T 1200 34 V56 H0 Z\' fill=\'%23b3e5fc\'/%3E%3C/svg%3E');"></div>
    <div class="wave wave2" style="background:url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'56\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 34 Q 150 10 300 34 T 600 34 T 900 34 T 1200 34 V56 H0 Z\' fill=\'%230288d1\'/%3E%3C/svg%3E');"></div>
    <div class="wave wave3" style="background:url('data:image/svg+xml,%3Csvg width=\'1200\' height=\'56\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 34 Q 150 10 300 34 T 600 34 T 900 34 T 1200 34 V56 H0 Z\' fill=\'%2301569b\'/%3E%3C/svg%3E');"></div>
  </header>

  <main class="main">
    <div class="controls">
      <label for="monthSelect">Select Month: </label>
      <select id="monthSelect">
        <option value="Average">2025 Average</option>
        <option value="Jul">July</option>
        <option value="Aug">August</option>
        <option value="Sep">September</option>
        <option value="Oct">October</option>
        <option value="Nov">November</option>
        <option value="Dec">December</option>
      </select>
    </div>

    <div id="lastUpdated">Last updated: Loading...</div>

    <div class="container" id="tableWrapper">
      <table id="dataTable" role="table" aria-label="Water meter readings table"></table>
    </div>
  </main>

  <script>
    // This is the URL for the Google Apps Script Web App you provided
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxttncBaDzW83nysVTpt1YHWGUoHefuUELfuoNZ-W-4vQWqhcHQN7LaoAMBBfqwV9s/exec";

const GID_MAP = {
  "Average": "676595147",
  "Jul": "2038204618",
  "Aug": "812809410",
  "Sep": "555648873",
  "Oct": "521072477",
  "Nov": "1962131756",
  "Dec": "397538262"
};
/* ---------------------------------------------------------------- */

const monthSelect = document.getElementById('monthSelect');
const table = document.getElementById('dataTable');
const lastUpdatedDiv = document.getElementById('lastUpdated');

/* small util: show shimmer rows while loading */
function showShimmer(rows=6, cols=10){
  table.classList.remove('visible');
  table.innerHTML = '';
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  for(let c=0;c<cols;c++){
    const th = document.createElement('th');
    th.innerHTML = '<div class="shimmer"></div>';
    trh.appendChild(th);
  }
  thead.appendChild(trh);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  for(let r=0;r<rows;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<cols;c++){
      const td = document.createElement('td');
      td.innerHTML = '<div class="shimmer"></div>';
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
}

/* fetch lastModified timestamp endpoint */
async function fetchLastModifiedTimestamp(){
  try {
    const res = await fetch(`${APPS_SCRIPT_WEB_APP_URL}?info=lastModified`);
    if(!res.ok) return null;
    const j = await res.json();
    return j.lastModified || null;
  } catch(err){
    return null;
  }
}

/* cache helper */
function getCacheKey(month){ return `cwss-data-${month}`; }

/* fetch sheet data (gid) */
async function fetchSheetData(gid){
  const res = await fetch(`${APPS_SCRIPT_WEB_APP_URL}?gid=${gid}`);
  if(!res.ok) throw new Error('Fetch failed: ' + res.status);
  const data = await res.json();
  return data;
}

/* determine colspan to the right from (row, col) in header matrix */
function computeColspan(matrix, r, c){
  const base = String(matrix[r][c] != null ? matrix[r][c] : '').trim();
  let colspan = 1;
  for(let cc = c+1; cc < matrix[r].length; cc++){
    const val = String(matrix[r][cc] != null ? matrix[r][cc] : '').trim();
    if(val === '' || val === base) colspan++;
    else break;
  }
  return colspan;
}

/* determine rowspan downwards from (row, col) */
function computeRowspan(matrix, r, c, headerRows){
  const base = String(matrix[r][c] != null ? matrix[r][c] : '').trim();
  let rowspan = 1;
  for(let rr = r+1; rr < headerRows; rr++){
    const val = String(matrix[rr][c] != null ? matrix[rr][c] : '').trim();
    if(val === '' || val === base) rowspan++;
    else break;
  }
  return rowspan;
}

/* Render table headers using matrix first 3 rows.
   This algorithm reads first headerRows (3) from dataMatrix and
   creates th elements with correct rowspan & colspan based on
   consecutive blanks / repeated values returned by Sheets' getDisplayValues.
*/
function renderHeadersFromMatrix(dataMatrix, headerRows = 3){
  // make a working copy and ensure each header row same length
  const header = [];
  const maxCols = Math.max(...dataMatrix.slice(0, headerRows).map(r => r.length));
  for(let r=0; r<headerRows; r++){
    header[r] = (dataMatrix[r] || []).slice();
    while(header[r].length < maxCols) header[r].push('');
  }

  // used to mark covered cells to avoid double rendering
  const covered = Array.from({length: headerRows}, ()=> Array(maxCols).fill(false));

  const thead = document.createElement('thead');

  for(let r=0; r<headerRows; r++){
    const tr = document.createElement('tr');
    for(let c=0; c<maxCols; c++){
      if(covered[r][c]) continue;
      const raw = header[r][c] != null ? String(header[r][c]).trim() : '';
      // if empty string, it will usually be part of a merged area started earlier horizontally,
      // but in some rare sheet layouts it might be standalone: skip but fill a blank th for consistent layout.
      if(raw === ''){
        // check if it's truly standalone (no top-left start) -> create empty cell
        // but more robust approach: skip to next column (we will rely on top-left starts)
        continue;
      }
      const colspan = computeColspan(header, r, c);
      const rowspan = computeRowspan(header, r, c, headerRows);

      // mark covered cells
      for(let rr = r; rr < r + rowspan; rr++){
        for(let cc = c; cc < c + colspan; cc++){
          if(rr < headerRows && cc < maxCols) covered[rr][cc] = true;
        }
      }

      const th = document.createElement('th');
      th.textContent = raw;
      if(colspan > 1) th.colSpan = colspan;
      if(rowspan > 1) th.rowSpan = rowspan;

      // apply group coloring heuristics (text contains MLD or Litter etc.)
      const tLower = raw.toLowerCase();
      if(tLower.includes('mld')) th.classList.add('group-mld');
      else if(tLower.includes('litter') || tLower.includes('litre') || tLower.includes('liters') || tLower.includes('litres')) th.classList.add('group-litres');

      tr.appendChild(th);
    }
    thead.appendChild(tr);
  }

  return thead;
}

/* render body rows ensuring consistent column count */
function renderBodyFromMatrix(dataMatrix, headerRows=3){
  const maxCols = Math.max(...dataMatrix.slice(0, headerRows).map(r => r.length));
  const tbody = document.createElement('tbody');
  for(let r = headerRows; r < dataMatrix.length; r++){
    const row = (dataMatrix[r] || []).slice();
    while(row.length < maxCols) row.push('');
    const tr = document.createElement('tr');
    // small styling helpers
    const firstVal = String(row[0] || '');
    if(/total/i.test(firstVal)) tr.className = 'total-row';
    else if(/average/i.test(firstVal)) tr.className = 'average-row';
    else if(((r-headerRows) % 2) === 0) tr.classList.add('row-even');

    for(let c=0;c<maxCols;c++){
      const td = document.createElement('td');
      td.textContent = row[c] != null ? row[c] : '';
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  return tbody;
}

/* Main renderer: takes sheet data matrix and builds table (headers + body) */
function buildTableFromSheetData(dataMatrix){
  table.classList.remove('visible');
  table.innerHTML = '';

  // need at least 3 header rows to build merged header correctly
  if(!Array.isArray(dataMatrix) || dataMatrix.length < 3){
    table.innerHTML = '<thead><tr><th>No data</th></tr></thead>';
    return;
  }

  // build header
  const thead = renderHeadersFromMatrix(dataMatrix, 3);
  table.appendChild(thead);

  // build body
  const tbody = renderBodyFromMatrix(dataMatrix, 3);
  table.appendChild(tbody);

  // show table with fade-in
  requestAnimationFrame(()=> {
    table.classList.add('visible');
  });
}

/* Primary function: checks cache, lastModified, fetches sheet if needed */
async function fetchAndShow(monthKey){
  try {
    showShimmer(6, 10);
    // always fetch latest timestamp
    const lastMod = await fetchLastModifiedTimestamp();
    if(lastMod){
      lastUpdatedDiv.textContent = 'Last updated: ' + (new Date(lastMod)).toLocaleString('en-US', { dateStyle:'medium', timeStyle:'short' });
    } else {
      lastUpdatedDiv.textContent = 'Last updated: Unknown';
    }

    const cacheKey = getCacheKey(monthKey);
    const cached = (() => {
      try { return JSON.parse(localStorage.getItem(cacheKey)); } catch(e) { return null; }
    })();

    // if cached and same lastModified, use it for instant load
    if(cached && cached.sheetLastModified && lastMod && String(cached.sheetLastModified) === String(lastMod)){
      buildTableFromSheetData(cached.data);
      return;
    }

    // else fetch fresh sheet data
    const gid = GID_MAP[monthKey];
    const dataMatrix = await fetchSheetData(gid);

    // cache it
    try {
      localStorage.setItem(cacheKey, JSON.stringify({ data: dataMatrix, sheetLastModified: lastMod || Date.now() }));
    } catch(e){ /* ignore storage errors */ }

    buildTableFromSheetData(dataMatrix);

  } catch(err){
    console.error(err);
    table.innerHTML = '<thead><tr><th>Error loading data</th></tr></thead>';
  }
}

/* wire controls */
monthSelect.addEventListener('change', ()=> fetchAndShow(monthSelect.value));
document.addEventListener('DOMContentLoaded', ()=> fetchAndShow(monthSelect.value));
</script>
</body>
</html>
