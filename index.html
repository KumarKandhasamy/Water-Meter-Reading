<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Punjai Thalavaipalyam Panjayath CWSS-138/238 - Water Meter Readings 2025</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f3f4f6;
      padding: 20px;
    }
    h2 {
      color: #1e3a8a;
      text-align: center;
    }
    select {
      padding: 6px;
      margin: 10px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
    }
    table {
      width: 100%;
      min-width: 800px; /* Ensure minimum width to prevent collapse */
      border-collapse: collapse;
      font-size: 12px;
      background: white;
      margin-top: 10px;
      table-layout: fixed; /* Fixed layout to control column widths */
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
      word-wrap: break-word; /* Prevent text overflow */
    }
    th {
      background-color: #2563eb !important;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .row-even {
      background-color: #f9fafb !important;
    }
    .total-row {
      background-color: #a3e635 !important; /* Green for Total */
      font-weight: bold;
    }
    .average-row {
      background-color: #fde047 !important; /* Yellow for Average */
      font-weight: bold;
    }
    .mld-group {
      background-color: #93c5fd !important; /* Light blue for MLD */
    }
    .litres-group {
      background-color: #d8b4fe !important; /* Light purple for Litres */
    }
    #lastUpdated {
      font-size: 12px;
      color: #6b7280;
      margin: 10px 0;
      text-align: center;
    }
    .container {
      overflow-x: auto; /* Ensure horizontal scroll if needed */
    }
    /* Specific column widths for better layout */
    #dataTable th:nth-child(1),
    #dataTable td:nth-child(1) { width: 5%; } /* S.No */
    #dataTable th:nth-child(2),
    #dataTable td:nth-child(2) { width: 10%; } /* Date */
    #dataTable th:nth-child(3),
    #dataTable td:nth-child(3) { width: 15%; } /* Main Ent (MLD) */
    #dataTable th:nth-child(4),
    #dataTable td:nth-child(4) { width: 15%; } /* MGP C&EK (MLD) */
    #dataTable th:nth-child(5),
    #dataTable td:nth-child(5) { width: 10%; } /* MGP (MLD) */
    #dataTable th:nth-child(6),
    #dataTable td:nth-child(6) { width: 10%; } /* Main Ent (CWSS-238 MLD) */
    #dataTable th:nth-child(7),
    #dataTable td:nth-child(7) { width: 10%; } /* Main Ent (Litters) */
    #dataTable th:nth-child(8),
    #dataTable td:nth-child(8) { width: 15%; } /* MGP C&EK (Litters) */
    #dataTable th:nth-child(9),
    #dataTable td:nth-child(9) { width: 10%; } /* MGP (Litters) */
    #dataTable th:nth-child(10),
    #dataTable td:nth-child(10) { width: 5%; } /* Sump (Litters) */
    #dataTable th:nth-child(11),
    #dataTable td:nth-child(11) { width: 5%; } /* Main Ent (CWSS-238 Litters) */
  </style>
</head>
<body>

  <h2>Punjai Thalavaipalyam Panjayath CWSS-138/238 - Water Meter Readings 2025</h2>

  <div style="text-align: center;">
    <label for="monthSelect">Select Month: </label>
    <select id="monthSelect">
      <option value="Average">2025 Average</option>
      <option value="Jul">July</option>
      <option value="Aug">August</option>
      <option value="Sep">September</option>
      <option value="Oct">October</option>
      <option value="Nov">November</option>
      <option value="Dec">December</option>
    </select>
  </div>

  <div id="lastUpdated">Last updated: Loading...</div>
  <div class="container">
    <table id="dataTable"></table>
  </div>

  <script>
    const SPREADSHEET_ID = "2PACX-1vSZgyKDVKi31ku5JZ3sHK9HO0ncbIAJkTOzyFZgXw7KVZ9bi7oMqbgUkILKjF1zaVP4GcchfUHFTTVs";

    const GID_MAP = {
      "Average": "676595147",
      "Jul": "2038204618",
      "Aug": "812809410",
      "Sep": "555648873",
      "Oct": "521072477",
      "Nov": "1962131756",
      "Dec": "397538262"
    };

    const monthSelect = document.getElementById("monthSelect");
    const table = document.getElementById("dataTable");
    const lastUpdatedDiv = document.getElementById("lastUpdated");

    function parseCSV(csv) {
      const rows = csv.trim().split("\n").map(row => row.split(",").map(cell => cell.trim()));

      let headerRowIndex = -1;
      // Find the header row (e.g., "S.No,Date,Main Ent,..." or similar with at least 3 meaningful columns)
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        // Heuristic: Check for "S.No" and "Date" in the row, and ensure enough filled cells
        if (row.includes("S.No") && row.includes("Date") && row.filter(cell => cell !== '').length >= 3) {
          headerRowIndex = i;
          break;
        }
      }

      if (headerRowIndex === -1) {
        console.warn("Header row not found. Using first row as header.");
        headerRowIndex = 0; // Fallback to first row if no clear header is found
      }

      const rawDataRows = rows.slice(headerRowIndex);

      // Determine the column range based on the header row
      const header = rawDataRows[0];
      let firstFilledCol = -1;
      let lastFilledCol = -1;

      for (let i = 0; i < header.length; i++) {
        if (header[i] !== '') {
          if (firstFilledCol === -1) {
            firstFilledCol = i;
          }
          lastFilledCol = i;
        }
      }

      // If no filled headers, or header is too sparse, try to find the actual data start
      if (firstFilledCol === -1 || lastFilledCol === -1) {
          console.warn("Header row is empty or too sparse. Attempting to find column range from data.");
          firstFilledCol = Infinity;
          lastFilledCol = -1;

          // Check a few rows after the potential header for meaningful data to define column bounds
          for (let i = 1; i < Math.min(rawDataRows.length, 10); i++) { // Check up to 10 data rows
              rawDataRows[i].forEach((cell, colIdx) => {
                  if (cell !== '') {
                      if (colIdx < firstFilledCol) firstFilledCol = colIdx;
                      if (colIdx > lastFilledCol) lastFilledCol = colIdx;
                  }
              });
          }
          if (firstFilledCol === Infinity) firstFilledCol = 0; // Fallback if no data found
          if (lastFilledCol === -1) lastFilledCol = header.length - 1; // Fallback if no data found
      }


      // Crop all data rows to the identified column range
      const processedRows = rawDataRows.map(row => row.slice(firstFilledCol, lastFilledCol + 1));

      return processedRows;
    }

    function fetchSheetData(month) {
      const gid = GID_MAP[month];
      const url = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_ID}/pub?gid=${gid}&single=true&output=csv`;

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error("Failed to fetch data");
          return response.text();
        })
        .then(csv => {
          const processedRows = parseCSV(csv);

          if (processedRows.length < 2) { // Need at least a header and one data row
            table.innerHTML = "<tr><td colspan='100%'>No data or insufficient data available for this month.</td></tr>";
            return;
          }

          // Clear previous table
          table.innerHTML = "";

          // Add header with dynamic color assignment
          const headerRow = document.createElement("tr");
          const headers = processedRows[0];
          headers.forEach((header, idx) => {
            const th = document.createElement("th");
            // Remove "Column X" placeholder if header is truly empty or irrelevant
            let displayHeader = header || '';
            // Condition to ignore "Column 2" and "Column 3" if they appear as empty placeholders
            if (displayHeader.match(/^Column [23]$/)) {
                 displayHeader = '';
            }
            th.textContent = displayHeader;

            // Apply group classes based on header content
            if (displayHeader.includes("MLD")) th.classList.add("mld-group");
            else if (displayHeader.includes("Litters")) th.classList.add("litres-group");
            headerRow.appendChild(th);
          });
          table.appendChild(headerRow);

          // Add data rows with merging and color coding
          for (let i = 1; i < processedRows.length; i++) {
            const row = processedRows[i];
            const tr = document.createElement("tr");
            tr.className = (i - 1) % 2 === 0 ? "row-even" : "";

            // Apply special row classes for Total and Average
            if (row[0] && row[0].toLowerCase() === "total") tr.className = "total-row";
            else if (row[0] && row[0].toLowerCase() === "average") tr.className = "average-row";

            row.forEach((cell, colIdx) => {
              const td = document.createElement("td");
              td.textContent = cell || ""; // Handle empty cells

              // Apply color groups based on the actual header content
              if (headers[colIdx] && headers[colIdx].includes("MLD")) td.classList.add("mld-group");
              else if (headers[colIdx] && headers[colIdx].includes("Litters")) td.classList.add("litres-group");

              tr.appendChild(td);
            });
            table.appendChild(tr);
          }
        })
        .catch(err => {
          console.error("Fetch Error:", err);
          table.innerHTML = "<tr><td colspan='100%'>Failed to load data</td></tr>";
        });
    }

    function updateLastUpdatedToCurrentTime() {
      const now = new Date();
      lastUpdatedDiv.textContent = `Last updated: ${now.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}`;
    }

    // Event listener for dropdown
    monthSelect.addEventListener("change", () => {
      const selectedMonth = monthSelect.value;
      fetchSheetData(selectedMonth);
      updateLastUpdatedToCurrentTime();
    });

    // Initial load
    fetchSheetData(monthSelect.value);
    updateLastUpdatedToCurrentTime();
  </script>

</body>
</html>
